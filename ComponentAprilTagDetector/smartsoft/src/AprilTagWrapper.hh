//--------------------------------------------------------------------------
// Code generated by the SmartSoft MDSD Toolchain
// The SmartSoft Toolchain has been developed by:
//
// Service Robotics Research Center
// University of Applied Sciences Ulm
// Prittwitzstr. 10
// 89075 Ulm (Germany)
//
// Information about the SmartSoft MDSD Toolchain is available at:
// www.servicerobotik-ulm.de
//
// This file is generated once. Modify this file to your needs.
// If you want the toolchain to re-generate this file, please
// delete it before running the code generator.
//--------------------------------------------------------------------------
//  Copyright (C) 2020 Nayabrasul Shaik
//
//        nayabrasul.shaik@thu.de
//
//        Christian Schlegel (christian.schlegel@thu.de)
//        University of Applied Sciences
//        Prittwitzstr. 10
//        89075 Ulm (Germany)
//
//
//  This library is free software; you can redistribute it and/or
//  modify it under the terms of the GNU Lesser General Public
//  License as published by the Free Software Foundation; either
//  version 2.1 of the License, or (at your option) any later version.
//
//  This library is distributed in the hope that it will be useful,
//  but WITHOUT ANY WARRANTY; without even the implied warranty of
//  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
//  Lesser General Public License for more details.
//
//  You should have received a copy of the GNU Lesser General Public
//  License along with this library; if not, write to the Free Software
//  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
//-------------------------------------------------------------------------

#ifndef SMARTSOFT_SRC_APRILTAGWRAPPER_HH_
#define SMARTSOFT_SRC_APRILTAGWRAPPER_HH_

#include "CommTrackingObjects/CommDetectedMarkerList.hh"
#include "DomainVision/CommVideoImage.hh"
#include "3rdParty/apriltag/apriltag.h"
#include "3rdParty/apriltag/apriltag_pose.h"
#include "opencv2/core.hpp"
//#include "OpenCVHelpers/OpenCVHelpers.hh"
#include <vector>

#ifdef _WIN32
#define TEXT_COLOR_RESET   ""
#define TEXT_COLOR_GREEN   ""
#define TEXT_COLOR_RED     ""
#elif __linux__
#define TEXT_COLOR_RESET   "\033[0m"
#define TEXT_COLOR_GREEN   "\033[32m"
#define TEXT_COLOR_RED     "\033[31m"
#endif

class AprilTagWrapper {

private:
	apriltag_family_t *tag_family;
	apriltag_detector_t *tag_detector;
	apriltag_detection_info_t detection_info;
	double decision_threshold;

	//GUI stuff to draw markers on the image
	struct MarkerGUIData
	{
		CommBasicObjects::CommPose3d pose;
		std::vector<cv::Point> corners;
		unsigned long tag_id;
	};
	std::vector<MarkerGUIData> gui_data;
public:
	AprilTagWrapper();
	virtual ~AprilTagWrapper();

	//Detection
	void set_detector_options();
	void create_and_add_tag_family(std::string family);
	void destroy_tag_family(apriltag_family_t *tag_family);
	void set_detector_decimate(double decimate);
	void set_detector_sigma(double sigma);
	void set_detector_num_threads(uint8_t nthreads);
	void set_detector_debug(bool debug);
	void set_detector_refine_edges(bool refine_edges);
	bool set_intrinsic_parameters(DomainVision::CommVideoImage &input_image);
	void set_marker_size(double size);
	void set_decision_threshold(double threshold);
	void process_image(DomainVision::CommVideoImage &input_image, CommTrackingObjects::CommDetectedMarkerList& markers_list);
	void display_options();

	//util
	void april_tag_pose_to_commpose3d(apriltag_pose_t& april_pose, CommBasicObjects::CommPose3d& comm_pose);
	void rotation_matrix_to_eurle_angles(double rotation_mat[], double& roll, double& elevation, double& azimuth);
	//IplImage* convertDataArrayToIplImage(DomainVision::CommVideoImage &query_image, CvSize size);

	//GUI
	void draw_markers(DomainVision::CommVideoImage& image);
	void draw_marker_text(cv::Mat& image, const cv::Point& point, const std::string& text);
	void draw_marker_corners(cv::Mat& image, const std::vector<cv::Point>& corners);
	double pi_to_pi(double angle);
};
std::ostream& operator<<(std::ostream& os, const apriltag_pose_t& ap);
#endif /* SMARTSOFT_SRC_APRILTAGWRAPPER_HH_ */
